---
title: "RBS library : S011"
author: "Prashant"
date: "July 9, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning=F, fig.width = 14, fig.height = 3.5)
source('./general_functions_plate_reading.R')
```

## User inputs


User inputs for multiple sheets

```{r input data, message=F, results='hide'}
# User inputs: 1. Enter name of the excel file, 2. Name of the data sheet(S) 3. number of rows and columns in plate reader data 4. Title for plots #comment (file name starts in the previous directory of this Rproject)

flnm <- 'S011_pPK6.2,7.2_RBS library_16-5-19'

flpath <- str_c('../',flnm,'.xlsx')
fl <- read_plateReader_file(flpath) # load all non empty sheets of the excel file into fl - as a list 
sheet_names <- c( "Primary","Uninduced","Induced") # list the sheets to be loaded
n_Rows <- 5; 
n_Cols <- 12; 
# check the number of rows and columns for first sheet listed below
```

## Data crunching

Copy the tables of GFP, OD, Sample names etc. in excel and run the command below to get it into R
Doing calculations with the tables, relating sample names with the values

```{r data analysis}
table_c0 <- extract_from_given_sheet(sheet_names[1], 5, 12) %>% mutate(Inducer = 'Primary') # extracing from each sheet
table_c1 <- extract_from_given_sheet(sheet_names[2], n_Rows, n_Cols) %>% mutate(Inducer = '0 uM')
table_c2 <- extract_from_given_sheet(sheet_names[3], n_Rows, n_Cols) %>% mutate(Inducer = '1 uM')

merged2 <- bind_rows(table_c0,table_c1,table_c2) # merge all sheets into 1 table

all_days_table <- merged2 %>% mutate(category  = fct_lump(Samples, 2, other_level = 'Controls')) %>% mutate(Samples = fct_relevel(Samples,'6.2','7.2')) %>% arrange(Samples) %>% mutate(Samples = as.character(Samples)) # make a new column for frequent categories
all_days_table$Samples[1:72] <-  rep(str_c('6.', 1:24)) # name each colony with a number
all_days_table$Samples[73:144] <- rep(str_c('7.', 1:24)) # name each colony with a number
all_days_table$Samples %<>%  fct_inorder() # make samples factor again

# determine plotting order: based on ascending order of GFP/RFP values
plotting_order <- all_days_table %>% group_and_summarize_at() %>% filter(str_detect(Inducer,'0')) %>% arrange(mean) %>% ungroup() %>%  mutate(Samples = fct_inorder(Samples)) %>% pull(Samples) %>% levels()

all_days_table$Samples %<>% fct_relevel(plotting_order) # manually reorder samples for plotting

all_days_gathered <- all_days_table %>% gather(key = 'Measurement', value = 'Reading', OD, GFP, RFP, 'GFP/RFP', 'GFP/OD', 'RFP/OD') # gather different measurements and ratios into 1 column

```

## Data tables

Showing raw data and processed data here 

GFP/RFP values
``` {r}
# Not showing anything for now # format with colours etc for good visualization
```


## Plotting

Plotting GFP/RFP : mean and sd

```{r plotting1}
sel_table1 <- all_days_table %>% group_and_summarize_at() #%>% filter(!str_detect(Samples, "MG|LB")) %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt1 <- ggplot(sel_table1, aes(Samples, mean, colour = Inducer, shape = Inducer)) + geom_point(size = 2) + facet_wrap(~ category, scales = 'free_x') + scale_shape_manual(values = c(18,19,2)) + ylab('GFP/RFP (a.u.)') + ggtitle('RBS mutant library')
plt2 <- plt1 %>% format_classic() %>% format_logscale()
plt2

```

Plotting GFP/OD : mean and sd

```{r plotting2}
sel_table2 <- all_days_table %>% group_and_summarize_at('GFP/OD') #%>% filter(!str_detect(Samples, "MG|LB")) %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt3 <- ggplot(sel_table2, aes(Samples, mean, colour = Inducer, shape = Inducer)) + geom_point(size = 2) + facet_wrap(~ category, scales = 'free_x') + scale_shape_manual(values = c(18,19,2)) + ylab('GFP/OD (a.u.)') + ggtitle('RBS mutant library')
plt4 <- plt3 %>% format_classic() %>% format_logscale()
plt4
```

Merge all GFP/OD

```{r plotting3}
sel_table3 <- sel_table2 %>% arrange(Inducer, mean) %>% ungroup() %>%  mutate(Samples = fct_inorder(Samples)) # arrange samples in ascending order of uninduced
plt5 <- ggplot(sel_table3, aes(Samples, mean, colour = Inducer, shape = Inducer)) + geom_point(size = 2) + scale_shape_manual(values = c(18,19,2)) + ylab('GFP/OD (a.u.)') + ggtitle('RBS mutant library')
plt6 <- plt5 %>% format_classic() %>% format_logscale()
plt6
```

Plotting GFP/OD and RFP/OD: mean and SD

```{r plotting4}
sel_table4 <- all_days_table %>% group_and_summarize_at(c('GFP/OD','RFP/OD')) %>% filter(!str_detect(Inducer,'-')) #%>% arrange(Inducer, Measurement, mean) %>% ungroup() %>%  mutate(Samples = fct_inorder(Samples)) # arrange samples in ascending order of uninduced # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt7 <- ggplot(sel_table4, aes(Samples, mean, colour = Measurement, shape = Inducer)) + geom_point(size = 2) + scale_shape_manual(values = c(1,19,2)) + facet_wrap(~ category, scales = 'free_x') + ylab('Fluorescence/OD (a.u.)') + ggtitle('RBS mutant library')
plt8 <- plt7 %>% format_classic() %>% format_logscale()
plt8 #+ scale_colour_manual(values = c('#4daf4a' ,'#e41a1c'))
```

Plotting OD : mean and SD

```{r plotting5}
sel_table3 <- all_days_table %>% group_and_summarize_at('OD') %>% filter(!str_detect(Samples, "LB")) %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt5 <- ggplot(sel_table3, aes(Time, mean, colour = Inducer)) + geom_point(size = 1) +  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.25) + facet_wrap(~ Samples) + geom_line() + scale_x_continuous(breaks = c(0,6,24,48)) + ylab('OD') + ggtitle('AHL flipping with time') 
plt6 <- plt5 %>% format_classic()
plt6
```

Plotting all GFP/OD and RFP/OD (individual replicates)

```{r plotting6}
sel_table2 <- all_days_gathered %>% filter(str_detect(Measurement,"^GFP/OD|^RFP/")) %>% filter(!str_detect(Samples, "LB|MG")) %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting

plt3 <- ggplot(sel_table2, aes(Time, Reading, colour = Measurement, shape = Inducer, group = interaction(Inducer, Measurement, `Replicate #`))) + geom_line() + geom_point(size = 2) + scale_shape_manual(values = c(1,19)) + facet_wrap(~Samples, scales = 'fixed') +  scale_x_continuous(breaks = c(0,6,24,48)) + ylab('Fluorescence/OD (a.u.)') + ggtitle('AHL flipping with time') 
plt4 <- plt3 %>% format_classic() # %>% format_logscale()
plt4 #+ scale_colour_manual(values = c('#4daf4a' ,'#e41a1c'))
# ggsave('plots and data/S015_linear.png', plt1)
# ggsave('plots and data/test.png', width = 14/3, height = 11.34/3)
```
