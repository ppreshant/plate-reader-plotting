---
title: "Plate reader plotting : S019"
author: "Prashant"
date: "Dec 1, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning=F, fig.width = 8, fig.height = 4)
# fig.width = 14/3, fig.height = 11.34/3
source('./general_functions_plate_reading.R')
```

## User inputs


User inputs for multiple sheets

```{r input data, message=F, results='hide'}
# User inputs: 1. Enter name of the excel file, 2. Name of the data sheet(S) to exclude 3. number of rows and columns in plate reader data 4. Title for plots 
# Comment (make sure excel file is in the parent directory of the Rproject file or code)

flnm <- 'S019_6-11-19'
sheets_to_exclude <- 'analysis|dil' # regular expression for sheets to be excluded

n_Rows <- 8; # default full 96 well plate = 8 rows x 12 columns
n_Cols <- 12; 
# check the number of rows and columns for first sheet listed below

plotting_order <- c("pRV01", "pInt8", "pPK7/8", "pPK7/17","Controls") # order of plotting for samples

flpath <- str_c('../',flnm,'.xlsx')
fl <- read_plateReader_file(flpath) # load all non empty sheets of the excel file into fl - as a list 
sheet_names <- names(fl) %>% .[!str_detect(., sheets_to_exclude)] # get the list of sheets unless excluded
# sheet_names <- c("0 h","6 h","24 h", "48 h", "72 h", "96 h") # list the sheets to be loaded manually
sheet_times <- sheet_names %>% str_split(' ') %>% unlist() %>% .[rep(c(T,F))] %>% as.numeric() # extracting the hour time from sheet name 
sheet_time_x_axis <- sheet_times %>% as.integer() %>% unique() # retain only integers for plotting x axis time variable
```

## Data crunching

Copy the tables of GFP, OD, Sample names etc. in excel and run the command below to get it into R
Doing calculations with the tables, relating sample names with the values

```{r data analysis}
tables_cx <- map2(sheet_names, sheet_times, ~ extract_from_given_sheet(.x, n_Rows, n_Cols) %>% mutate(Time = .y)) # extracing OD, GFP and RFP from each sheet (vectorized)

merged2 <- bind_rows(tables_cx) # merge all sheets into 1 table

all_days_table <- merged2 %>% separate(Samples, into = c('Samples', 'Reporter'), sep = '\\_| \\+ ') %>% mutate(Reporter = if_else(is.na(Reporter)|str_detect(Reporter,"rM"), Samples, Reporter), Samples = if_else(Samples == Reporter, "Controls", Samples), Samples = if_else(str_detect(Reporter,'^[:digit:]*$'), str_c(Samples,Reporter, sep = '_'), Samples) , Reporter  = str_replace(Reporter, 'rG$|^[:digit:]*$', 'rGFP')) # Samples has the recombinase plasmid or controls and reporter has the reporter plasmid
# details: split into 2 columns by _ and +; make singleton entries as controls and put name in Reporter; make mutants ex: pPK7_17 into 1 sample name and reporter as the default rGFP (also replace shorthand notation rG with rGFP) 

all_days_table %<>% filter(!str_detect(Reporter, 'LB'))
all_days_table %<>% mutate(Reporter = fct_inorder(Reporter), Reporter = fct_relevel(Reporter, 'rGFP', "fGFP")) # arranging samples again to make up for factor mismatch
all_days_table$Samples %<>% fct_relevel(plotting_order) # manually reorder sample order for plotting

all_days_gathered <- all_days_table %>% gather(key = 'Measurement', value = 'Reading', OD, GFP, RFP, 'GFP/RFP', 'GFP/OD', 'RFP/OD') # gather different measurements and ratios into 1 column

```

## Data tables

Showing raw data and processed data here 

GFP/RFP values
``` {r}
# Not showing anything for now # format with colours etc for good visualization
```


## Plotting

Plotting GFP/OD of all data: logscale

```{r plotting1}
sel_table1 <- all_days_table %>% group_and_summarize_at('GFP/OD') %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt1 <- plot_time_series(sel_table1, x_breaks = sheet_time_x_axis)


plt1f <- plt1 %>% format_logscale()
plt1f
```

Plotting GFP/OD all data in linearscale

```{r plotting1linear}
plt1
```

Interactive plot: GFP/OD all data in linearscale

```{r plotting1interactive}
plt1 %>% ggplotly()
```

Plotting GFP/OD zoom in to mutants

```{r plotting1mutants}
sel_table1_mutants <- sel_table1 %>% filter(str_detect(Samples, 'pPK'))
plot_time_series(sel_table1_mutants, x_breaks = sheet_time_x_axis, stroke_width = .5) +  annotate('rect', xmin = 8, ymin = 0, xmax = 9, ymax = Inf, alpha = .2) 
```

## Individual measurement plots
(GFP, RFP, OD and GFP/RFP)

Plotting GFP 

```{r plotting2_GFP}
sel_table2_GFP <- all_days_table %>% group_and_summarize_at('GFP') %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt2 <- plot_time_series(sel_table2_GFP, x_breaks = sheet_time_x_axis, y_axis_label = 'GFP (a.u.)')
plt2
```

Plotting OD 

```{r plotting3}
sel_table3_OD <- all_days_table %>% group_and_summarize_at('OD') %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt3 <- plot_time_series(sel_table3_OD, x_breaks = sheet_time_x_axis, y_axis_label = 'OD 600')
plt3
```

Plotting OD: Zoomed to Specific control samples

```{r plotting3_zoom}
sel_table3_OD_select <- sel_table3_OD %>% filter(str_detect(Samples, "Control"), !str_detect(Reporter, 'pSH')) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt3 <- plot_time_series(sel_table3_OD_select, x_breaks = sheet_time_x_axis, y_axis_label = 'OD 600')
plt3
```

Plotting RFP 

```{r plotting4_RFP}
sel_table4_RFP <- all_days_table %>% group_and_summarize_at('RFP') %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt4 <- plot_time_series(sel_table4_RFP, x_breaks = sheet_time_x_axis, y_axis_label = 'RFP (a.u.)')
plt4
```

Plotting RFP/OD : linear

```{r plotting5_RFP/OD}
sel_table5 <- all_days_table %>% group_and_summarize_at('RFP/OD') %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt5 <- plot_time_series(sel_table5, x_breaks = sheet_time_x_axis, y_axis_label = 'RFP/OD (a.u.)')
plt5
# ggsave('plots and data/S015_linear.png', plt1)
# ggsave('plots and data/test.png', width = 14/3, height = 11.34/3)
```

Plotting RFP/OD : Logscale
```{r plotting5_RFP/OD log}
plt5f <- plt5 %>% format_logscale()
plt5f
```


Plotting GFP/RFP : mean and sd

```{r plotting5b_GFP/RFP}
sel_table5b <- all_days_table %>% group_and_summarize_at('GFP/RFP') %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt5b <- plot_time_series(sel_table5b, x_breaks = sheet_time_x_axis, y_axis_label = 'GFP/RFP (a.u.)')
plt5bf <- plt5b %>% format_logscale()
plt5bf
# ggsave('plots and data/S015_linear.png', plt1)
# ggsave('plots and data/test.png', width = 14/3, height = 11.34/3)
```

<!-- Plotting all GFP/OD and RFP/OD (individual replicates) -->

<!-- ```{r plotting2} -->
<!-- sel_table2 <- all_days_gathered %>% filter(str_detect(Measurement,"^GFP/OD|^RFP/")) %>% filter(!str_detect(Samples, "LB|MG")) %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting -->

<!-- plt3 <- ggplot(sel_table2, aes(Time, Reading, colour = Measurement, shape = Inducer, group = interaction(Inducer, Measurement, `Replicate #`))) + geom_line() + geom_point(size = 2) + scale_shape_manual(values = c(1,19)) + facet_wrap(~Samples, scales = 'fixed') +  scale_x_continuous(breaks = c(0,6,24,48)) + ylab('Fluorescence/OD (a.u.)') + ggtitle('AHL flipping with time')  -->
<!-- plt4 <- plt3 %>% format_classic() # %>% format_logscale() -->
<!-- plt4 #+ scale_colour_manual(values = c('#4daf4a' ,'#e41a1c')) -->
<!-- # ggsave('plots and data/S015_linear.png', plt1) -->
<!-- # ggsave('plots and data/test.png', width = 14/3, height = 11.34/3) -->
<!-- ``` -->

## Other plots
### zoomed in, uninduced only and other exploratory plots

All uninduced GFP/OD

```{r plotting6 Uninduced}
# Extract desired data: only pRV01 - various days
sel_table6_uninduced <- all_days_table %>% group_and_summarize_at('GFP/OD') %>%  filter(str_detect(Inducer,'^0'))

plt6 <- plot_time_series(sel_table6_uninduced, x_breaks = sheet_time_x_axis)
plt6
```

WT pRV01 GFP/OD - uninduced : daily progression

```{r plotting6 selected uninduced}
# Extract desired data: only pRV01 - various days
sel_table6_uninduced_2 <- all_days_table %>% group_and_summarize_at('GFP/OD') %>%  filter(str_detect(Inducer,'^0')) %>% filter(str_detect(Samples, 'RV01|pInt|Control')) 

plt6_sel <- plot_time_series(sel_table6_uninduced_2, x_breaks = sheet_time_x_axis)
plt6_sel
```

Uninduced samples, zoomed in (excluding fGFP positive control)

```{r plotting6_uninduced_zoomed}
# Extract desired data
sel_table6_uninduced_zoom <- all_days_table %>% group_and_summarize_at('GFP/OD') %>%  filter(str_detect(Inducer,'^0') & str_detect(Samples, 'pRV|pPK|Controls') & !str_detect(Reporter, 'fGFP')) 
plt6_sel_zoom <- plot_time_series(sel_table6_uninduced_zoom, x_breaks = sheet_time_x_axis)
plt6_sel_zoom
```

Uninduced pRV01, pInt8 and controls, zoomed in (excluding fGFP positive control)

```{r plotting6_uninduced_zoomed_select}
# Extract desired data: exclude pPK7 mutants
sel_table6_uninduced_zoom_select <- sel_table6_uninduced_zoom %>% filter(str_detect(Samples, 'pRV|pInt|Controls')) 

plt6_sel_zoom <- plot_time_series(sel_table6_uninduced_zoom_select, x_breaks = sheet_time_x_axis)
plt6_sel_zoom
```

Uninduced controls, zoomed in (excluding fGFP positive control)

```{r plotting6_uninduced_zoomed_controls}
# Extract desired data: exclude pPK7 mutants
sel_table6_uninduced_zoom_controls <- sel_table6_uninduced_zoom %>% filter(str_detect(Samples, 'Controls')) 

plt6_sel_zoom_controls <- plot_time_series(sel_table6_uninduced_zoom_controls, x_breaks = sheet_time_x_axis)
plt6_sel_zoom_controls
```

Uninduced mutants and controls, zoomed in (excluding fGFP positive control)

```{r plotting6_uninduced_zoomed_mutants and controls}
# Extract desired data: exclude pPK7 mutants
sel_table6_uninduced_zoom_mutants <- sel_table6_uninduced_zoom %>% filter(!str_detect(Samples, 'pRV')) 

plt6_sel_zoom_mutants <- plot_time_series(sel_table6_uninduced_zoom_mutants, x_breaks = sheet_time_x_axis)
plt6_sel_zoom_mutants
```

## Specific plots for presentations

Plotting only WT pRV01: GFP/OD : linear scale

```{r plotting7}
sel_table1_pRV <- sel_table1 %>% filter(str_detect(Samples, "pRV") & str_detect(Reporter, 'pSH01|rGFP')) %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt7 <- plot_time_series(sel_table1_pRV, x_breaks = sheet_time_x_axis) + scale_colour_manual(values = 'black') + guides(colour = F)
plt7
```

Plotting controls, Arabinose induction pInt8 and AHL induction WT pRV01 : important reporters only: GFP/OD

```{r plotting8}
sel_table1_exclude_mutants <- sel_table1 %>% filter(str_detect(Samples, "pRV|pInt|Controls"), str_detect(Reporter, 'GFP')) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column
plt8 <- plot_time_series(sel_table1_exclude_mutants, x_breaks = sheet_time_x_axis) + annotate('rect', xmin = 8, ymin = 0, xmax = 9, ymax = Inf, alpha = .2)
plt8
```

Plotting Arabinose induction pInt8: important reporters only: GFP/OD

```{r plotting9}
sel_table1_pInt8 <- sel_table1 %>% filter(str_detect(Samples, "pInt"), str_detect(Reporter, 'GFP')) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column
plt9 <- plot_time_series(sel_table1_pInt8, x_breaks = sheet_time_x_axis) + annotate('rect', xmin = 8, ymin = 0, xmax = 9, ymax = Inf, alpha = .2)
plt9
```

Plotting controls, and AHL induction WT pRV01: important reporters only: GFP/OD

```{r plotting10}
sel_table1_pRV_Con <- sel_table1 %>% filter(str_detect(Samples, "pRV|Controls"), str_detect(Reporter, 'GFP')) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column
plt10 <- plot_time_series(sel_table1_pRV_Con, x_breaks = sheet_time_x_axis) + annotate('rect', xmin = 8, ymin = 0, xmax = 9, ymax = Inf, alpha = .2)
plt10
```

### Processed data plots (ratio of max and others)

Plotting GFP/OD normalized to the fGFP control at the respective point (<fGFP> of uninduced and induced)
- Grabs the mean of fGFP (3 biological replicates) at each condition
- Divide the mean and SD at each condition by this mean
- (In effect this is dividing each data point by this mean, the variability (SD) of the fGFP triplicates itself is ignored)
- (Warning: the division of two random variables is a complicated subject, cannot just divide the means - need to look into this in detail)

```{r plotting9}
sel_table_fGFP_modified <- sel_table1 %>% group_by(Samples, Time) %>% mutate_cond(Reporter == 'fGFP', 'mean' = mean(mean), 'sd' = mean(mean)) # average fGFP values at each time across inducer values (since fGFP control has no effect from the induction)
sel_table9_fraction_flip <- sel_table_fGFP_modified %>% ungroup() %>% mutate('mean' = mean/mean[Reporter == 'fGFP'], 'sd' = sd/sd[Reporter == 'fGFP']) %>% mutate_cond(Reporter == 'fGFP', 'sd' = 0) %>%  filter(Time < 9, str_detect(Samples, 'pRV|pInt|Controls')) # calculate ratio of fGFP per day and make SD of fGFP 0

plt9 <- plot_time_series(sel_table9_fraction_flip, x_breaks = sheet_time_x_axis, y_axis_label = 'Fraction of maximum GFP/OD')
plt9 #%>% format_logscale() %>% print()
```
<!-- On same plot: controls, Arabinose induction pInt8 and AHL induction WT pRV01 GFP/OD -->

<!-- ```{r plotting10} -->
<!-- sel_table1_exclude_mutants_only_rGFP <- sel_table1 %>% filter(str_detect(Samples, "pRV|pInt|Controls"), str_detect(Reporter,'GFP')) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column -->
<!-- plt10 <- ggplot(sel_table1_exclude_mutants_only_rGFP, aes(Time, mean, colour = Samples, shape = Inducer)) +  -->
<!--     annotate('rect', xmin = induction_duration[1], ymin = 0, xmax = induction_duration[2], ymax = Inf, alpha = .2) +  # grey rectangle for induction duration -->
<!--     geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.25) + geom_line() + geom_point(size = 2, fill = 'white', stroke = stroke_width) +  -->
<!--     scale_shape_manual(values = c(21,19)) +  scale_x_continuous(breaks = x_breaks) +  -->
<!--     ylab(y_axis_label) + xlab(x_axis_label) + ggtitle(plot_title) -->
<!-- plt10 -->
<!-- ``` -->
