---
author: "Prashant Kalvapalle"
date: '`r format(Sys.time(), "%d %B, %Y")`'
output: 
  html_document:
    theme: flatly
    toc: TRUE
    toc_float: TRUE
---

---
title: `r title_name`
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning=F, fig.width = 8, fig.height = 4)
# fig.width = 14/3, fig.height = 11.34/3
```


## Plotting

Plotting GFP/OD of higher [Induction]: logscale

```{r plotting1}

# filter neccesary samples for plotting ; mean and variance of any column
sel_table1 <- all_days_table %>% 
  group_and_summarize_at('GFP/OD') %>% 
  filter(Inducer > 0.6| Inducer == 0) # filtering above significant inducer conc. to reduce clutter

plt1 <- plot_time_series(sel_table1, x_breaks = sheet_times)


plt1f <- plt1 %>% format_logscale()
plt1f
```

Plotting GFP/OD higher [Induction] in linearscale

```{r plotting1linear}
plt1
```

Plotting GFP/OD higher [Induction] in linearscale : Interactive

```{r plotting1interactive}
plt1 %>% ggplotly()
```

Plotting GFP/OD important only higher [Induction]: WT and controls

```{r plotting1 WT and controls}
sel_table1_WT_Controls <- sel_table1 %>% filter(str_detect(Samples, 'RV01|pInt|Control')) 
plot_time_series(sel_table1_WT_Controls, x_breaks = sheet_times) %>% print()
```

Plotting GFP/OD zoom in to mutants higher [Induction]

```{r plotting1mutants}
sel_table1_mutants <- sel_table1 %>% filter(str_detect(Samples, 'pPK'))
plot_time_series(sel_table1_mutants, x_breaks = sheet_times) %>% print()
```

## Individual measurement plots
(GFP, RFP, OD and GFP/RFP)

Plotting GFP 

```{r plotting2_GFP}
sel_table2_GFP <- all_days_table %>% group_and_summarize_at('GFP') %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt2 <- plot_time_series(sel_table2_GFP, x_breaks = sheet_times, y_axis_label = 'GFP (a.u.)')
plt2
```

Plotting OD 

```{r plotting3}
sel_table3_OD <- all_days_table %>% group_and_summarize_at('OD') %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt3 <- plot_time_series(sel_table3_OD, x_breaks = sheet_times, y_axis_label = 'OD 600')
plt3
```

Plotting OD: Zoomed to Specific control samples

```{r plotting3_zoom}
sel_table3_OD_select <- sel_table3_OD %>% filter(str_detect(Samples, "Control"), !str_detect(Reporter, 'pSH')) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt3 <- plot_time_series(sel_table3_OD_select, x_breaks = sheet_times, y_axis_label = 'OD 600')
plt3
```

Plotting RFP 

```{r plotting4_RFP}
sel_table4_RFP <- all_days_table %>% group_and_summarize_at('RFP') %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt4 <- plot_time_series(sel_table4_RFP, x_breaks = sheet_times, y_axis_label = 'RFP (a.u.)')
plt4
```

Plotting RFP/OD : linear

```{r plotting5_RFP/OD}
sel_table5 <- all_days_table %>% group_and_summarize_at('RFP/OD') %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt5 <- plot_time_series(sel_table5, x_breaks = sheet_times, y_axis_label = 'RFP/OD (a.u.)')
plt5
# ggsave('plots and data/S015_linear.png', plt1)
# ggsave('plots and data/test.png', width = 14/3, height = 11.34/3)
```

Plotting RFP/OD : Logscale
```{r plotting5_RFP/OD log}
plt5f <- plt5 %>% format_logscale()
plt5f
```


Plotting GFP/RFP : mean and sd

```{r plotting5b_GFP/RFP}
sel_table5b <- all_days_table %>% group_and_summarize_at('GFP/RFP') %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt5b <- plot_time_series(sel_table5b, x_breaks = sheet_times, y_axis_label = 'GFP/RFP (a.u.)')
plt5bf <- plt5b %>% format_logscale()
plt5bf
# ggsave('plots and data/S015_linear.png', plt1)
# ggsave('plots and data/test.png', width = 14/3, height = 11.34/3)
```

<!-- Plotting all GFP/OD and RFP/OD (individual replicates) -->

<!-- ```{r plotting2} -->
<!-- sel_table2 <- all_days_gathered %>% filter(str_detect(Measurement,"^GFP/OD|^RFP/")) %>% filter(!str_detect(Samples, "LB|MG")) %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting -->

<!-- plt3 <- ggplot(sel_table2, aes(Time, Reading, colour = Measurement, shape = Inducer, group = interaction(Inducer, Measurement, `Replicate #`))) + geom_line() + geom_point(size = 2) + scale_shape_manual(values = c(1,19)) + facet_wrap(~Samples, scales = 'fixed') +  scale_x_continuous(breaks = c(0,6,24,48)) + ylab('Fluorescence/OD (a.u.)') + ggtitle('AHL flipping with time')  -->
<!-- plt4 <- plt3 %>% format_classic() # %>% format_logscale() -->
<!-- plt4 #+ scale_colour_manual(values = c('#4daf4a' ,'#e41a1c')) -->
<!-- # ggsave('plots and data/S015_linear.png', plt1) -->
<!-- # ggsave('plots and data/test.png', width = 14/3, height = 11.34/3) -->
<!-- ``` -->

## Other plots
### zoomed in, uninduced only and other exploratory plots

All uninduced GFP/OD

```{r plotting6 Uninduced}
# Extract desired data: only pRV01 - various days
sel_table6_uninduced <- all_days_table %>% group_and_summarize_at('GFP/OD') %>%  filter(str_detect(Inducer,'^0'))

plt6 <- plot_time_series(sel_table6_uninduced, x_breaks = sheet_times)
plt6
```

WT pRV01 GFP/OD - uninduced : daily progression

```{r plotting6 selected uninduced}
# Extract desired data: only pRV01 - various days
sel_table6_uninduced_2 <- all_days_table %>% group_and_summarize_at('GFP/OD') %>%  filter(str_detect(Inducer,'^0')) %>% filter(str_detect(Samples, 'RV01|pInt|Control')) 

plt6_sel <- plot_time_series(sel_table6_uninduced_2, x_breaks = sheet_times)
plt6_sel
```

Uninduced samples, zoomed in (excluding fGFP positive control)

```{r plotting6_uninduced_zoomed}
# Extract desired data
sel_table6_uninduced_zoom <- all_days_table %>% group_and_summarize_at('GFP/OD') %>%  filter(str_detect(Inducer,'^0') & str_detect(Samples, 'pRV|pPK|Controls') & !str_detect(Reporter, 'fGFP')) 
plt6_sel_zoom <- plot_time_series(sel_table6_uninduced_zoom, x_breaks = sheet_times)
plt6_sel_zoom
```

Uninduced pRV01, pInt8 and controls, zoomed in (excluding fGFP positive control)

```{r plotting6_uninduced_zoomed_select}
# Extract desired data: exclude pPK7 mutants
sel_table6_uninduced_zoom_select <- sel_table6_uninduced_zoom %>% filter(str_detect(Samples, 'pRV|pInt|Controls')) 

plt6_sel_zoom <- plot_time_series(sel_table6_uninduced_zoom_select, x_breaks = sheet_times)
plt6_sel_zoom
```

Uninduced controls, zoomed in (excluding fGFP positive control)

```{r plotting6_uninduced_zoomed_controls}
# Extract desired data: exclude pPK7 mutants
sel_table6_uninduced_zoom_controls <- sel_table6_uninduced_zoom %>% filter(str_detect(Samples, 'Controls')) 

plt6_sel_zoom_controls <- plot_time_series(sel_table6_uninduced_zoom_controls, x_breaks = sheet_times)
plt6_sel_zoom_controls
```

Uninduced mutants and controls, zoomed in (excluding fGFP positive control)

```{r plotting6_uninduced_zoomed_mutants and controls}
# Extract desired data: exclude pPK7 mutants
sel_table6_uninduced_zoom_mutants <- sel_table6_uninduced_zoom %>% filter(!str_detect(Samples, 'pRV')) 

plt6_sel_zoom_mutants <- plot_time_series(sel_table6_uninduced_zoom_mutants, x_breaks = sheet_times)
plt6_sel_zoom_mutants
```

Plotting GFP/OD of pRV01 only

```{r plotting9_pRV01 only}
sel_table9 <- all_days_table %>% group_and_summarize_at('GFP/OD') %>% filter(str_detect(Samples, 'pRV')) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt9 <- plot_time_series(sel_table9, x_breaks = sheet_times)

plt9
```

Plotting GFP/OD of pRV01 only

```{r plotting9_pInt8 only}
sel_table10 <- all_days_table %>% group_and_summarize_at('GFP/OD') %>% filter(str_detect(Samples, 'pInt')) %>% ungroup() %>%  mutate(Inducer = str_replace(Inducer, '-1', 'Glucose')) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt10 <- plot_time_series(sel_table10, x_breaks = sheet_times)

plt10 %>% ggplotly()
```


### Dose response plots

Plotting dose response by day: day 1

```{r plotting11}
sel_table11 <- all_days_table %>% group_and_summarize_at('GFP/OD') %>% filter(str_detect(Samples, 'pRV|pInt')) %>% ungroup() %>%  mutate(Inducer = as.numeric(Inducer)) %>% 
  filter(Time == 1 & Inducer != -1) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column
  

hill_table11 <- sel_table11 %>% group_by(Samples) %>% rename(L = Inducer, y = mean) %>% 
  nest() %>%  # seperate each group into a different data frame for fitting
  mutate (fit = map(data, hill_fit), y.fit = map(fit, broom::augment)) %>% # call hill fitting function on a single time point data
  unnest(y.fit)

  
# sel_table11.fit  <- sel_table11 %>% mutate(y.fit = hill_table11$y.fit) # take the fit curve for plotting

plt11 <- plot_dose_response(sel_table11) + geom_line(data = hill_table11, aes(x = L, y = .fitted), linetype = 2)

plt11
```

Plotting dose response by day (day 1 and 2)

```{r plotting12}
sel_table12 <- all_days_table %>% group_and_summarize_at('GFP/OD') %>% filter(str_detect(Samples, 'pRV|pInt')) %>% ungroup() %>%  mutate(Inducer = as.numeric(Inducer)) %>% 
  filter(Inducer != -1 & Time > 0 & Time < 3) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column
  

hill_table12 <- sel_table12 %>% group_by(Samples, Time) %>% rename(L = Inducer, y = mean) %>% 
  nest() %>%  # seperate each group into a different data frame for fitting
  mutate (fit = map(data, hill_fit), y.fit = map(fit, broom::augment)) %>% # call hill fitting function on a single time point data
  unnest(y.fit)

  
# sel_table11.fit  <- sel_table11 %>% mutate(y.fit = hill_table11$y.fit) # take the fit curve for plotting

plt12 <- plot_dose_response(sel_table12) + geom_line(data = hill_table12, aes(x = L, y = .fitted), linetype = 2) + aes(colour = factor(Time))

plt12

plt12 %>% format_logscale() %>% print()
```


Plotting dose response by day (joined points)

```{r plotting13}
sel_table13 <- all_days_table %>% group_and_summarize_at('GFP/OD') %>% filter(str_detect(Samples, 'pRV|pInt')) %>% ungroup() %>%  mutate(Inducer = as.numeric(Inducer)) %>% 
  filter(Inducer != -1) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column
  
# sel_table11.fit  <- sel_table11 %>% mutate(y.fit = hill_table11$y.fit) # take the fit curve for plotting

plot_dose_response(sel_table13) + geom_line() + aes(colour = factor(Time))

```


Plotting dose response d1, 2 (joined points)

```{r plotting13b}
sel_table13b <- all_days_table %>% group_and_summarize_at('GFP/OD') %>% filter(str_detect(Samples, '7_32')) %>% ungroup() %>%  mutate(Inducer = as.numeric(Inducer)) %>% 
   filter(Inducer != -1 & Time > 0 & Time < 3)  # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column
  
# sel_table11.fit  <- sel_table11 %>% mutate(y.fit = hill_table11$y.fit) # take the fit curve for plotting

plot_dose_response(sel_table13b) + geom_line() + aes(colour = factor(Time))

```


Plotting dose response by day (Controls)

```{r plotting14}
sel_table14 <- all_days_table %>% 
  group_and_summarize_at('GFP/OD') %>% 
  filter(str_detect(Samples, 'Control'), Reporter == 'pSH001') %>% 
  ungroup() %>% 
  mutate(Inducer = as.numeric(Inducer)) %>% 
  filter(Inducer != -1 & Time == 1) %>%  # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column
  na.omit()

hill_table14 <- sel_table14 %>% group_by(Samples, Reporter, Time) %>% rename(L = Inducer, y = mean) %>% 
  nest() %>%  # seperate each group into a different data frame for fitting
  mutate (fit = map(data, hill_fit), y.fit = map(fit, broom::augment)) %>% # call hill fitting function on a single time point data
  unnest(y.fit)

  
# sel_table11.fit  <- sel_table11 %>% mutate(y.fit = hill_table11$y.fit) # take the fit curve for plotting

plt14 <- plot_dose_response(sel_table14) + geom_line(data = hill_table14, aes(x = L, y = .fitted), linetype = 2) + aes(colour = Reporter)

plt14

plt14 %>% format_logscale() %>% print()
```

Plotting dose response by day (all plasmids)

```{r plotting15}
sel_table15 <- all_days_table %>% group_and_summarize_at('GFP/OD') %>% 
  # filter(str_detect(Samples, 'Control'), Reporter == 'pSH001') %>% 
  ungroup() %>% 
  mutate(Inducer = as.numeric(Inducer)) %>% 
  filter(Inducer != -1) %>%  # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column
  na.omit()

# hill_table15 <- sel_table15 %>% group_by(Samples, Reporter, Time) %>% rename(L = Inducer, y = mean) %>% 
#   nest() %>%  # seperate each group into a different data frame for fitting
#   mutate (fit = map(data, hill_fit), y.fit = map(fit, broom::augment)) %>% # call hill fitting function on a single time point data
#   unnest(y.fit)

  
# sel_table11.fit  <- sel_table11 %>% mutate(y.fit = hill_table11$y.fit) # take the fit curve for plotting

plt15 <- plot_dose_response(sel_table15) + geom_line() + aes(colour = factor(Time), label = ) 

plt15 %>% ggplotly(dynamicTicks = T)

```


Dose response day 1 : Realtime vs memory

```{r plotting16}
sel_table16 <- all_days_table %>% #group_and_summarize_at('GFP/OD') %>% 
  filter(str_detect(Samples, 'pRV|Controls')) %>% filter(str_detect(Reporter, 'rGFP|pSH')) %>% 
  ungroup() %>%  mutate(Inducer = as.numeric(Inducer)) %>% 
  filter(Time == 1) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column
  

# hill_table16 <- sel_table16 %>% group_by(Samples) %>% rename(L = Inducer, y = mean) %>% 
#   nest() %>%  # seperate each group into a different data frame for fitting
#   mutate (fit = map(data, hill_fit), y.fit = map(fit, broom::augment)) %>% # call hill fitting function on a single time point data
#   unnest(y.fit)

  
# sel_table11.fit  <- sel_table11 %>% mutate(y.fit = hill_table11$y.fit) # take the fit curve for plotting

plt16 <- {ggplot(sel_table16,
                 aes(Inducer, `GFP/OD`, colour = Samples, label = `Replicate #`)) + 
    geom_point() + 
    geom_line(aes(group = interaction(Samples, `Replicate #`)), alpha = 0.2) + 
    
    ylab('GFP/OD (a.u.)') + xlab('C12-AHL (nM)') +
    scale_x_log10(labels =  fancy_scientific)
  
} %>% {format_classic(.) + theme(legend.position = 'top')} %>% 
  print

ggsave('plate reader analysis/plots and data/S022_doseresponse_AHL.pdf', plt16, width = 4, height = 3)

```


Dose response day 1 : all plasmids

```{r plotting17}
sel_table17 <- all_days_table %>% #group_and_summarize_at('GFP/OD') %>% 
  # filter(str_detect(Samples, 'pRV|Controls')) %>% filter(str_detect(Reporter, 'rGFP|pSH')) %>% 
  ungroup() %>%  
  mutate(Inducer = as.numeric(Inducer)) %>% 
  filter(Time == 1) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt17 <- {ggplot(sel_table17,
                 aes(Inducer, `GFP/OD`, colour = Samples, label = `Replicate #`)) + 
    geom_point() + 
    geom_line(aes(group = interaction(Samples, `Replicate #`)), alpha = 0.2) + 
    
    theme(legend.position = 'top') + 
    ylab('GFP/OD (a.u.)') +
    scale_x_log10(labels =  fancy_scientific)
  
} %>% format_classic %>% 
  print

```


<!-- ## Specific plots for presentations -->

<!-- Plotting only WT pRV01: GFP/OD : linear scale -->

<!-- ```{r plotting7} -->
<!-- sel_table1b <- sel_table1 %>% filter(str_detect(Samples, "pRV") & str_detect(Reporter, 'pSH01|rGFP')) %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column -->
<!-- plt7 <- ggplot(sel_table1b, aes(Time, mean, shape = Inducer)) + annotate('rect', xmin = 0, ymin = 0, xmax = 6, ymax = Inf, alpha = .2) +  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 1) + facet_wrap(~ Samples, ncol = 1) + geom_line() + geom_point(size = 2, fill = 'white', stroke = 1.5) + scale_shape_manual(values = c(21,19)) +  scale_x_continuous(breaks = sheet_times) + ylab('GFP/OD (a.u.)') + xlab('Time (h)') + ggtitle('AHL flipping with time') + labs(shape = '[AHL]') -->
<!-- plt7f <- plt7 %>% format_classic() -->
<!-- plt7f -->
<!-- ``` -->

<!-- Plotting controls, Arabinose induction pInt8 and AHL induction WT pRV01: GFP/OD -->

<!-- ```{r plotting8} -->
<!-- sel_table1c <- sel_table1 %>% filter(str_detect(Samples, "pRV|pInt|Controls")) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column -->
<!-- plt8 <- ggplot(sel_table1c, aes(Time, mean, shape = Inducer, colour = Reporter)) + annotate('rect', xmin = 0, ymin = 0, xmax = 6, ymax = Inf, alpha = .2) +  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 1) + facet_wrap(~ Samples, ncol = 2) + geom_line() + geom_point(size = 2, fill = 'white', stroke = 1.1) + scale_shape_manual(values = c(21,19)) +  scale_x_continuous(breaks = sheet_times) + ylab('GFP/OD (a.u.)') + xlab('Time (h)') + ggtitle('AHL flipping with time') + labs(colour = 'Reporter', shape = '[AHL]') -->
<!-- plt8f <- plt8 %>% format_classic()  -->
<!-- plt8f -->
<!-- ``` -->

### Processed data plots (ratio of max and others)

<!-- Plotting GFP/OD normalized to the fGFP control at the respective point (<fGFP> of uninduced and induced) -->

<!-- ```{r plotting9} -->
<!-- sel_table7_fraction_flip <- sel_table1 %>% group_by() -->
<!-- plt8 <- ggplot(sel_table1c, aes(Time, mean, shape = Inducer, colour = Reporter)) + annotate('rect', xmin = 0, ymin = 0, xmax = 6, ymax = Inf, alpha = .2) +  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 1) + facet_wrap(~ Samples, ncol = 2) + geom_line() + geom_point(size = 2, fill = 'white', stroke = 1.1) + scale_shape_manual(values = c(21,19)) +  scale_x_continuous(breaks = sheet_times) + ylab('GFP/OD (a.u.)') + xlab('Time (h)') + ggtitle('AHL flipping with time') + labs(colour = 'Reporter', shape = '[AHL]') -->
<!-- plt8f <- plt8 %>% format_classic()  -->
<!-- plt8f -->
<!-- ``` -->