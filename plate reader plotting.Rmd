---
title: "Plate reader plotting : S015c"
author: "Prashant"
date: "June 2, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning=F, fig.width = 14/3, fig.height = 11.34/3)
source('./general_functions_plate_reading.R')
```

## User inputs


User inputs for multiple sheets

```{r input data, message=F, results='hide'}
# User inputs: 1. Enter name of the excel file, 2. Name of the data sheet(S) 3. number of rows and columns in plate reader data 4. Title for plots #comment (file name starts in the previous directory of this Rproject)

flnm <- 'S019_6-11-19'

flpath <- str_c('../',flnm,'.xlsx')
fl <- read_plateReader_file(flpath) # load all non empty sheets of the excel file into fl - as a list 
sheet_names <- c("0 h","6 h","24 h", "48 h", "72 h", "96 h") # list the sheets to be loaded
sheet_times <- sheet_names %>% str_split(' ') %>% unlist() %>% .[rep(c(T,F))] %>% as.numeric() # extracting the hour time from sheet name
# sheet_times <- c(0,6,24,48,72,96) # manual entry of sheet times

n_Rows <- 8; 
n_Cols <- 12; 
# check the number of rows and columns for first sheet listed below
plotting_order <- c("pRV01","pPK7/8", "pPK7/17","Controls") # order of plotting for samples
```

## Data crunching

Copy the tables of GFP, OD, Sample names etc. in excel and run the command below to get it into R
Doing calculations with the tables, relating sample names with the values

```{r data analysis}
tables_cx <- map2(sheet_names, sheet_times, ~ extract_from_given_sheet(.x, n_Rows, n_Cols) %>% mutate(Time = .y)) # extracing OD, GFP and RFP from each sheet (vectorized)

merged2 <- bind_rows(tables_cx) # merge all sheets into 1 table

all_days_table <- merged2 %>% separate(Samples, into = c('Samples', 'Reporter'), sep = '\\_| \\+ ') %>% mutate(Reporter = if_else(is.na(Reporter)|str_detect(Reporter,"rM"), Samples, Reporter), Samples = if_else(Samples == Reporter, "Controls", Samples), Samples = if_else(str_detect(Reporter,'^[:digit:]*$'), str_c(Samples,Reporter, sep = '_'), Samples) , Reporter  = str_replace(Reporter, 'rG$|^[:digit:]*$', 'rGFP')) # Samples has the recombinase plasmid or controls and reporter has the reporter plasmid
# details: split into 2 columns by _ and +; make singleton entries as controls and put name in Reporter; make mutants ex: pPK7_17 into 1 sample name and reporter as the default rGFP (also replace shorthand notation rG with rGFP) 

all_days_table %<>% mutate(Reporter = fct_inorder(Reporter), Reporter = fct_relevel(Reporter, 'rGFP', "fGFP")) # arranging samples again to make up for factor mismatch
all_days_table$Samples %<>% fct_relevel(plotting_order) # manually reorder sample order for plotting

all_days_gathered <- all_days_table %>% gather(key = 'Measurement', value = 'Reading', OD, GFP, RFP, 'GFP/RFP', 'GFP/OD', 'RFP/OD') # gather different measurements and ratios into 1 column



```

## Data tables

Showing raw data and processed data here 

GFP/RFP values
``` {r}
# Not showing anything for now # format with colours etc for good visualization
```


## Plotting

Plotting GFP/OD : mean and sd

```{r plotting5}
sel_table1 <- all_days_table %>% group_and_summarize_at('GFP/OD') %>% filter(!str_detect(Reporter, "LB")) %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt9 <- ggplot(sel_table1, aes(Time, mean, shape = Inducer, colour = Reporter, group = interaction(Reporter, Inducer))) + geom_point(size = 2) +  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.25) + facet_wrap(~ Samples) + geom_line() + scale_shape_manual(values = c(1,19)) +  scale_x_continuous(breaks = c(0,6,24,48)) + ylab('GFP/OD (a.u.)') + ggtitle('AHL flipping with time') + labs(colour = '[AHL]')
plt10 <- plt9 %>% format_classic() %>% format_logscale()
plt10
```

## Extra plots

Plotting GFP/RFP : mean and sd

```{r plottingGFP/RFP}
sel_table5 <- all_days_table %>% group_and_summarize_at() %>% filter(!str_detect(Reporter, "LB")) %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt1 <- ggplot(sel_table5, aes(Time, mean, shape = Inducer, colour = Reporter)) + geom_point(size = 2) +  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.25) + facet_wrap(~ Samples) + geom_line() + scale_shape_manual(values = c(1,19)) + scale_x_continuous(breaks = c(0,6,24,48)) + ylab('GFP/RFP (a.u.)') + ggtitle('AHL flipping with time') + labs(colour = '[AHL]')
plt2 <- plt1 %>% format_classic() %>% format_logscale()
plt2
# ggsave('plots and data/S015_linear.png', plt1)
# ggsave('plots and data/test.png', width = 14/3, height = 11.34/3)
```

<!-- Plotting GFP/OD and RFP/OD: mean and SD -->

<!-- ```{r plotting4} -->
<!-- sel_table4 <- all_days_table %>% group_and_summarize_at(c('GFP/OD','RFP/OD')) %>% filter(!str_detect(Samples, "LB|MG")) %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column -->
<!-- sel_table4_gathered <- sel_table4 %>% gather(key = 'Measurement', value = 'Reading', -Samples, -Inducer, -Time, -Reporter) %>% separate(Measurement, into = c('Measurement','val'),"_") %>% spread(val,Reading) # Seperate mean and variance and group by variable of measurement -->

<!-- plt7 <- ggplot(sel_table4_gathered, aes(Time, mean, colour = Measurement, shape = Inducer)) + geom_point(size = 2) +  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.25) + facet_wrap(~ Samples) + geom_line() + scale_shape_manual(values = c(1,19)) + scale_x_continuous(breaks = c(0,6,24,48)) + ylab('Fluorescence/OD (a.u.)') + xlab('Time (hr)') + ggtitle('AHL flipping with time')  -->
<!-- plt8 <- plt7 %>% format_classic() -->
<!-- plt8 #+ scale_colour_manual(values = c('#4daf4a' ,'#e41a1c')) -->
<!-- ``` -->

Plotting OD : mean and SD

```{r plotting3}
sel_table3 <- all_days_table %>% group_and_summarize_at('OD') %>% filter(!str_detect(Samples, "LB")) %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column

plt5 <- ggplot(sel_table3, aes(Time, mean, colour = Inducer)) + geom_point(size = 1) +  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 0.25) + facet_wrap(~ Samples) + geom_line() + scale_x_continuous(breaks = c(0,6,24,48)) + ylab('OD') + ggtitle('AHL flipping with time') 
plt6 <- plt5 %>% format_classic()
plt6
```

Plotting all GFP/OD and RFP/OD (individual replicates)

```{r plotting2}
sel_table2 <- all_days_gathered %>% filter(str_detect(Measurement,"^GFP/OD|^RFP/")) %>% filter(!str_detect(Samples, "LB|MG")) %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting

plt3 <- ggplot(sel_table2, aes(Time, Reading, colour = Measurement, shape = Inducer, group = interaction(Inducer, Measurement, `Replicate #`))) + geom_line() + geom_point(size = 2) + scale_shape_manual(values = c(1,19)) + facet_wrap(~Samples, scales = 'fixed') +  scale_x_continuous(breaks = c(0,6,24,48)) + ylab('Fluorescence/OD (a.u.)') + ggtitle('AHL flipping with time') 
plt4 <- plt3 %>% format_classic() # %>% format_logscale()
plt4 #+ scale_colour_manual(values = c('#4daf4a' ,'#e41a1c'))
# ggsave('plots and data/S015_linear.png', plt1)
# ggsave('plots and data/test.png', width = 14/3, height = 11.34/3)
```


WT pRV01 GFP/OD - uninduced : daily progression

```{r plotting2wt, fig.width = 5, fig.height = 3.5}
# Extract desired data: only pRV01 - various days
sel_table2_wt <- all_days_table %>% group_and_summarize_at('GFP/OD') %>%  filter(str_detect(Inducer,'^0')) %>% filter(str_detect(Samples, 'RV01|Control')) 

plt2 <- ggplot(sel_table2_wt, aes(Time, mean, colour = Reporter, shape = Inducer)) + geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 1) + geom_line() + geom_point(size = 2, fill = 'white') + scale_shape_manual(values = c(21,19)) + facet_wrap(~ Samples, ncol = 2) + ggtitle('Un-induced flipping with time') + ylab('GFP/OD (a.u.)') + scale_x_continuous(breaks = c(0,6,24,48)) # + geom_hline(yintercept = WT_baseline, linetype = 2) +  geom_hline(yintercept = rGFP_baseline, linetype = 2) # plot the mean, add y axis label and a baseline indication

plt2a <- plt2 %>% format_classic() 
plt2a# + ylim(0, 2000)
```

Uninduced samples, zoomed in (excluding fGFP positive control)

```{r plotting_uninduced_zoomed, fig.width = 5, fig.height = 3.5}
# Extract desired data: only pRV01 - various days
sel_table2_zoom<- sel_table2_wt %>% filter(!str_detect(Reporter, 'fGFP')) 

plt2z <- ggplot(sel_table2_zoom, aes(Time, mean, colour = Reporter, shape = Inducer)) + geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 1) + geom_line() + geom_point(size = 2, fill = 'white') + scale_shape_manual(values = c(21,19)) + facet_wrap(~ Samples, ncol = 2) + ggtitle('Un-induced flipping with time') + ylab('GFP/OD (a.u.)') + scale_x_continuous(breaks = c(0,6,24,48)) # + geom_hline(yintercept = WT_baseline, linetype = 2) +  geom_hline(yintercept = rGFP_baseline, linetype = 2) # plot the mean, add y axis label and a baseline indication

plt2za <- plt2z %>% format_classic() 
plt2za# + ylim(0, 2000)
```


Plotting only WT and pSH01 : GFP/OD : mean and sd (thesis proposal)

```{r plotting5b}
sel_table1b <- sel_table1 %>% filter(str_detect(Samples, "pRV|pSH")) %>% filter(!str_detect(Inducer, "s")) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column
plt9b <- ggplot(sel_table1b, aes(Time, mean, shape = Inducer)) + annotate('rect', xmin = 0, ymin = 0, xmax = 6, ymax = Inf, alpha = .2) +  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 1) + facet_wrap(~ Samples, ncol = 1) + geom_line() + geom_point(size = 2, fill = 'white') + scale_shape_manual(values = c(21,19)) +  scale_x_continuous(breaks = c(0,6,24,48)) + ylab('GFP/OD (a.u.)') + xlab('Time (h)') + ggtitle('AHL flipping with time') + labs(shape = '[AHL]')
plt10b <- plt9b %>% format_classic() 
plt10b
```

Plotting controls and WT: GFP/OD : mean and sd with facets (thesis proposal)

```{r plotting5c}
sel_table1c <- sel_table1 %>% filter(str_detect(Samples, "pRV|Controls")) # filter neccesary samples for plotting ; by default mean and variance of GFP/RFP column
plt9c <- ggplot(sel_table1c, aes(Time, mean, shape = Inducer, colour = Reporter)) + annotate('rect', xmin = 0, ymin = 0, xmax = 6, ymax = Inf, alpha = .2) +  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), width = 1) + facet_wrap(~ Samples, ncol = 2) + geom_line() + geom_point(size = 2, fill = 'white') + scale_shape_manual(values = c(21,19)) +  scale_x_continuous(breaks = c(0,6,24,48)) + ylab('GFP/OD (a.u.)') + xlab('Time (h)') + ggtitle('AHL flipping with time') + labs(colour = 'Reporter', shape = '[AHL]')
plt10c <- plt9c %>% format_classic() 
plt10c
```
